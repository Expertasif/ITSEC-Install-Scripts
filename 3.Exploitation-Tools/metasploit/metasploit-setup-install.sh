#!/bin/bash

bold=$(tput bold)
normal=$(tput sgr0)

GITREPO=https://github.com/rapid7/metasploit-framework
BRANCH=master
GITREPOROOT=/opt/ITSEC/3.Exploitation-Tools/metasploit-framework/rapid7/metasploit-framework
RBENVEXECDIR=/opt/ITSEC-Install-Scripts/3.Exploitation-Tools/metasploit/rbenv-sh
GITCLONEDIR=/opt/ITSEC/3.Exploitation-Tools/metasploit-framework/rapid7
EXECUTEABLE1=msfconsole.sh 
EXECUTEABLE2=msfd.sh 
EXECUTEABLE3=msfrpc.sh 
EXECUTEABLE4=msfrpcd.sh
EXECUTEABLE5=msfvenom.sh
EXECUTEABLE6=msfbinscan.sh
EXECUTEABLE7=msfelfscan.sh
EXECUTEABLE8=msfmachscan.sh 
EXECUTEABLE9=msfpescan.sh
EXECUTEABLE10=msfupdate.sh
BINDIR=/usr/local/bin
DSKTPFLS=/opt/ITSEC-Install-Scripts/0.Initial/usrlcl/.local/share/applications/3.Exploitation-Tools/MSF
DSKTPFLSDEST=/home/$USER/.local/share/applications/3.Exploitation-Tools/MSF
DSKTPFL1=msfconsole.desktop
DSKTPFL2=msfbinscan.desktop
DSKTPFL3=msfelfscan.desktop
DSKTPFL4=msfmachscan.desktop
DSKTPFL5=msfpescan.desktop
DSKTPFL6=msfrop.desktop
DSKTPFL7=msfvenom.desktop
DSKTPFL7=msfupdate.desktop
RUBYVERSION=$(lynx --dump https://raw.githubusercontent.com/rapid7/metasploit-framework/$BRANCH/.ruby-version )
GITSBMDLINIT () {
	git submodule init
	git submodule update --recursive
	sudo updatedb && sudo ldconfig
}

echo "${bold}
 __  __ _____ _____  _    ____  ____  _     ___ ___ _____ 
|  \/  | ____|_   _|/ \  / ___||  _ \| |   / _ \_ _|_   _|
| |\/| |  _|   | | / _ \ \___ \| |_) | |  | | | | |  | |  
| |  | | |___  | |/ ___ \ ___) |  __/| |__| |_| | |  | |  
|_|  |_|_____| |_/_/   \_\____/|_|   |_____\___/___| |_|  
           
INSTALL
${normal}"


mkdir -p $GITCLONEDIR
cd $GITCLONEDIR
git clone -b $BRANCH $GITREPO
cd $GITREPOROOT

### DEPS:
## Installed w apt lists - see /opt/ITSEC-Install-Scripts/0.Initial/lst/apt
# sudo apt-get update
# sudo apt-get upgrade
# xargs -a <(awk '/^\s*[^#]/' "$APTLSTDIR/deps-metasploit.txt") -r -- sudo apt-get install -y
source ~/.bashrc
eval "$(rbenv init -)"
yes "N" | rbenv install $RUBYVERSION
rbenv rehash

rbenv shell $RUBYVERSION 
### DEPS END

GITSBMDLINIT

sudo gem install bundler
bundle install

sudo rm -f $BINDIR/msf*
sudo bash -c 'for MSF in $(ls msf*); do ln -s /opt/ITSEC/3.Exploitation-Tools/metasploit-framework/rapid7/metasploit-framework/$MSF $BINDIR/$MSF;done'


sudo rm -f $BINDIR/msfupdate

chmod +x $RBENVEXECDIR/$EXECUTEABLE1
chmod +x $RBENVEXECDIR/$EXECUTEABLE2
chmod +x $RBENVEXECDIR/$EXECUTEABLE3
chmod +x $RBENVEXECDIR/$EXECUTEABLE4
chmod +x $RBENVEXECDIR/$EXECUTEABLE5
chmod +x $RBENVEXECDIR/$EXECUTEABLE6
chmod +x $RBENVEXECDIR/$EXECUTEABLE7
chmod +x $RBENVEXECDIR/$EXECUTEABLE8
chmod +x $RBENVEXECDIR/$EXECUTEABLE9
chmod +x $RBENVEXECDIR/$EXECUTEABLE10

cp $RBENVEXECDIR/$EXECUTEABLE1 $EXECUTEABLE1
cp $RBENVEXECDIR/$EXECUTEABLE2 $EXECUTEABLE2
cp $RBENVEXECDIR/$EXECUTEABLE3 $EXECUTEABLE3
cp $RBENVEXECDIR/$EXECUTEABLE4 $EXECUTEABLE4
cp $RBENVEXECDIR/$EXECUTEABLE5 $EXECUTEABLE5
cp $RBENVEXECDIR/$EXECUTEABLE6 $EXECUTEABLE6
cp $RBENVEXECDIR/$EXECUTEABLE7 $EXECUTEABLE7
cp $RBENVEXECDIR/$EXECUTEABLE8 $EXECUTEABLE8
cp $RBENVEXECDIR/$EXECUTEABLE9 $EXECUTEABLE9
cp $RBENVEXECDIR/$EXECUTEABLE10 $EXECUTEABLE10

sudo rm -f $BINDIR/$EXECUTEABLE1
sudo rm -f $BINDIR/$EXECUTEABLE2
sudo rm -f $BINDIR/$EXECUTEABLE3
sudo rm -f $BINDIR/$EXECUTEABLE4
sudo rm -f $BINDIR/$EXECUTEABLE5
sudo rm -f $BINDIR/$EXECUTEABLE6
sudo rm -f $BINDIR/$EXECUTEABLE7
sudo rm -f $BINDIR/$EXECUTEABLE8
sudo rm -f $BINDIR/$EXECUTEABLE9
sudo rm -f $BINDIR/$EXECUTEABLE10

sudo ln -s $GITREPOROOT/$EXECUTEABLE1 $BINDIR/$EXECUTEABLE1
sudo ln -s $GITREPOROOT/$EXECUTEABLE1 $BINDIR/$EXECUTEABLE1
sudo ln -s $GITREPOROOT/$EXECUTEABLE1 $BINDIR/$EXECUTEABLE1
sudo ln -s $GITREPOROOT/$EXECUTEABLE1 $BINDIR/$EXECUTEABLE1
sudo ln -s $GITREPOROOT/$EXECUTEABLE1 $BINDIR/$EXECUTEABLE1
sudo ln -s $GITREPOROOT/$EXECUTEABLE1 $BINDIR/$EXECUTEABLE1
sudo ln -s $GITREPOROOT/$EXECUTEABLE1 $BINDIR/$EXECUTEABLE1
sudo ln -s $GITREPOROOT/$EXECUTEABLE1 $BINDIR/$EXECUTEABLE1
sudo ln -s $GITREPOROOT/$EXECUTEABLE1 $BINDIR/$EXECUTEABLE1
sudo ln -s $GITREPOROOT/$EXECUTEABLE1 $BINDIR/$EXECUTEABLE1



cat > $GITREPOROOT/config/database.yml << EOF
production:
    adapter: postgresql
    database: msf
    username: msf
    password: msf
    host: 127.0.0.1
    port: 5432
    pool: 75
    timeout: 5
EOF

sudo sh -c "echo export MSF_DATABASE_CONFIG=$GITREPOROOT/config/database.yml >> /etc/profile"
source /etc/profile
sudo ldconfig
sudo updatedb
msfconsole --version
mkdir -p $DSKTPFLSDEST && cp $DSKTPFLS/$DSKTPFL1 $DSKTPFLSDEST/$DSKTPFL1
mkdir -p $DSKTPFLSDEST && cp $DSKTPFLS/$DSKTPFL2 $DSKTPFLSDEST/$DSKTPFL2
mkdir -p $DSKTPFLSDEST && cp $DSKTPFLS/$DSKTPFL3 $DSKTPFLSDEST/$DSKTPFL3
mkdir -p $DSKTPFLSDEST && cp $DSKTPFLS/$DSKTPFL4 $DSKTPFLSDEST/$DSKTPFL4
mkdir -p $DSKTPFLSDEST && cp $DSKTPFLS/$DSKTPFL5 $DSKTPFLSDEST/$DSKTPFL5
mkdir -p $DSKTPFLSDEST && cp $DSKTPFLS/$DSKTPFL6 $DSKTPFLSDEST/$DSKTPFL6
mkdir -p $DSKTPFLSDEST && cp $DSKTPFLS/$DSKTPFL7 $DSKTPFLSDEST/$DSKTPFL7
mkdir -p $DSKTPFLSDEST && cp $DSKTPFLS/$DSKTPFL8 $DSKTPFLSDEST/$DSKTPFL8
echo "done"