#!/bin/bash

bold=$(tput bold)
normal=$(tput sgr0)

echo "${bold}
 __  __ _____ _____  _    ____  ____  _     ___ ___ _____ 
|  \/  | ____|_   _|/ \  / ___||  _ \| |   / _ \_ _|_   _|
| |\/| |  _|   | | / _ \ \___ \| |_) | |  | | | | |  | |  
| |  | | |___  | |/ ___ \ ___) |  __/| |__| |_| | |  | |  
|_|  |_|_____| |_/_/   \_\____/|_|   |_____\___/___| |_|  
           
${normal}"



#######################################################################
############################# SETUP START #############################
#######################################################################
# Stripped version of the standalone installer
#
############################# VARIABLES START #########################

mkdir -p /opt/ITSEC/3.Exploitation-Tools/metasploit-framework/rapid7
cd /opt/ITSEC/3.Exploitation-Tools/metasploit-framework/rapid7
git clone https://github.com/rapid7/metasploit-framework
#

MSFINSTALLDIR=/opt/ITSEC/3.Exploitation-Tools/metasploit-framework/rapid7/metasploit-framework
RBENVEXECDIR=/opt/ITSEC-Install-Scripts/3.Exploitation-Tools/metasploit/rbenv-sh
#
DSKTPFLS=/opt/ITSEC-Install-Scripts/0.Initial/usrlcl/.local/share/applications/3.Exploitation-Tools/MSF
DSKTPFLSDEST=/home/$USER/.local/share/applications/3.Exploitation-Tools/MSF
DSKTPFL1=msfconsole.desktop
DSKTPFL2=msfbinscan.desktop
DSKTPFL3=msfelfscan.desktop
DSKTPFL4=msfmachscan.desktop
DSKTPFL5=msfpescan.desktop
DSKTPFL6=msfrop.desktop
DSKTPFL7=msfvenom.desktop
DSKTPFL7=msfupdate.desktop



# deps installed from list PT2
source ~/.bashrc
eval "$(rbenv init -)"
RUBYVERSION=$(lynx --dump https://raw.githubusercontent.com/rapid7/metasploit-framework/master/.ruby-version )

rbenv shell $RUBYVERSION 

cd $MSFINSTALLDIR
sudo ldconfig
sudo updatedb
git clean -f
git fetch origin
git reset --hard origin/master
git pull
git submodule init && git submodule update --recursive
sudo gem install bundler
bundle install

sudo rm -f /usr/local/bin/msf*
sudo bash -c 'for MSF in $(ls msf*); do ln -s /opt/ITSEC/3.Exploitation-Tools/metasploit-framework/rapid7/metasploit-framework/$MSF /usr/local/bin/$MSF;done'


sudo rm -f /usr/local/bin/msfupdate

chmod +x $RBENVEXECDIR/msfconsole.sh 
chmod +x $RBENVEXECDIR/msfd.sh 
chmod +x $RBENVEXECDIR/msfrpc.sh 
chmod +x $RBENVEXECDIR/msfrpcd.sh 
chmod +x $RBENVEXECDIR/msfvenom.sh 
chmod +x $RBENVEXECDIR/msfbinscan.sh 
chmod +x $RBENVEXECDIR/msfelfscan.sh 
chmod +x $RBENVEXECDIR/msfmachscan.sh 
chmod +x $RBENVEXECDIR/msfpescan.sh
chmod +x $RBENVEXECDIR/msfupdate.sh

cp $RBENVEXECDIR/msfconsole.sh msfconsole.sh
cp $RBENVEXECDIR/msfd.sh msfd.sh
cp $RBENVEXECDIR/msfrpc.sh msfrpc.sh
cp $RBENVEXECDIR/msfrpcd.sh msfrpcd.sh
cp $RBENVEXECDIR/msfvenom.sh msfvenom.sh
cp $RBENVEXECDIR/msfbinscan.sh msfbinscan.sh
cp $RBENVEXECDIR/msfelfscan.sh msfelfscan.sh
cp $RBENVEXECDIR/msfmachscan.sh msfmachscan.sh
cp $RBENVEXECDIR/msfpescan.sh msfpescan.sh
cp $RBENVEXECDIR/msfupdate.sh msfupdate.sh

sudo rm -f /usr/local/bin/msfconsole.sh
sudo rm -f /usr/local/bin/msfd.sh
sudo rm -f /usr/local/bin/msfrpc.sh
sudo rm -f /usr/local/bin/msfrpcd.sh
sudo rm -f /usr/local/bin/msfvenom.sh
sudo rm -f /usr/local/bin/msfbinscan.sh
sudo rm -f /usr/local/bin/msfelfscan.sh
sudo rm -f /usr/local/bin/msfmachscan.sh
sudo rm -f /usr/local/bin/msfpescan.sh
sudo rm -f /usr/local/bin/msfupdate.sh

sudo ln -s $MSFINSTALLDIR/msfconsole.sh /usr/local/bin/msfconsole.sh
sudo ln -s $MSFINSTALLDIR/msfd.sh /usr/local/bin/msfd.sh
sudo ln -s $MSFINSTALLDIR/msfrpc.sh /usr/local/bin/msfrpc.sh
sudo ln -s $MSFINSTALLDIR/msfrpcd.sh /usr/local/bin/msfrpcd.sh
sudo ln -s $MSFINSTALLDIR/msfvenom.sh /usr/local/bin/msfvenom.sh
sudo ln -s $MSFINSTALLDIR/msfbinscan.sh /usr/local/bin/msfbinscan.sh
sudo ln -s $MSFINSTALLDIR/msfelfscan.sh /usr/local/bin/msfelfscan.sh
sudo ln -s $MSFINSTALLDIR/msfmachscan.sh /usr/local/bin/msfmachscan.sh
sudo ln -s $MSFINSTALLDIR/msfpescan.sh /usr/local/bin/msfpescan.sh
sudo ln -s $MSFINSTALLDIR/msfupdate.sh /usr/local/bin/msfupdate.sh
sudo ln -s $MSFINSTALLDIR/msfupdate.sh /usr/local/bin/msfupdate


cat > $MSFINSTALLDIR/config/database.yml << EOF
production:
    adapter: postgresql
    database: msf
    username: msf
    password: msf
    host: 127.0.0.1
    port: 5432
    pool: 75
    timeout: 5
EOF

sudo sh -c "echo export MSF_DATABASE_CONFIG=$MSFINSTALLDIR/config/database.yml >> /etc/profile"
source /etc/profile
sudo ldconfig
sudo updatedb
msfconsole --version
mkdir -p $DSKTPFLSDEST && cp $DSKTPFLS/$DSKTPFL1 $DSKTPFLSDEST/$DSKTPFL1
mkdir -p $DSKTPFLSDEST && cp $DSKTPFLS/$DSKTPFL2 $DSKTPFLSDEST/$DSKTPFL2
mkdir -p $DSKTPFLSDEST && cp $DSKTPFLS/$DSKTPFL3 $DSKTPFLSDEST/$DSKTPFL3
mkdir -p $DSKTPFLSDEST && cp $DSKTPFLS/$DSKTPFL4 $DSKTPFLSDEST/$DSKTPFL4
mkdir -p $DSKTPFLSDEST && cp $DSKTPFLS/$DSKTPFL5 $DSKTPFLSDEST/$DSKTPFL5
mkdir -p $DSKTPFLSDEST && cp $DSKTPFLS/$DSKTPFL6 $DSKTPFLSDEST/$DSKTPFL6
mkdir -p $DSKTPFLSDEST && cp $DSKTPFLS/$DSKTPFL7 $DSKTPFLSDEST/$DSKTPFL7
mkdir -p $DSKTPFLSDEST && cp $DSKTPFLS/$DSKTPFL8 $DSKTPFLSDEST/$DSKTPFL8
echo "done"